<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="author" content="wilsonIsOnly" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>追梦者 / Content Security Policy 入门教程</title>
<link rel="icon" href="/favicon.png" type="image/x-icon" />
<link rel="shortcut icon" href="/favicon.png" type="image/x-icon" />
<link href="http://tony0511.github.io//blog/feed.xml" rel="alternate" title="追梦者" type="application/atom+xml" />
<link rel="stylesheet" href="/lib/font-awesome/font-awesome.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/blog.css" />
<link rel="stylesheet" type="text/css" href="/assets/css/code/sunburst.css" />

<style>
	.particles-js-canvas-el {
	    position: absolute;
	    left: 0;
	    top: 0;
	    z-index: -1;
	}

	/*最近访客的设置*/
	#visitors{
		text-align: center;
	}
	#visitors p{
		font-weight: bold;
	    font-size: 16px;
	    padding: 20px;
	}
	#ds-recent-visitors {
	    display: flex;
	    justify-content: center;
	}
</style>
</head>

<body class="page-type-post">

<div class="main">
	<div class="trace">/ <a href="/blog/">追梦者</a> / Content Security Policy 入门教程</div>

<article>
	<h1><a href="/blog/posts/content-security-policy">Content Security Policy 入门教程</a></h1>
	
	<p class="meta">
	<span class="datetime">2016-10-26</span> posted in [<a href="/blog/category/experience" class="category">How To Do</a>]
</p>
	<h1 id="content-security-policy-入门教程">Content Security Policy 入门教程</h1>

<p>跨域脚本攻击 XSS 是最常见、危害最大的网页安全漏洞。</p>

<p><img src="http://i.imgur.com/nf8fmxd.png" alt="" /></p>

<p>为了防止它们，要采取很多编程措施，非常麻烦。很多人提出，能不能根本上解决问题，浏览器自动禁止外部注入恶意脚本？</p>

<p>这就是”网页安全政策”（Content Security Policy，缩写 CSP）的来历。本文详细介绍如何使用 CSP 防止 XSS 攻击。</p>

<p><img src="http://i.imgur.com/ur5Udqe.jpg" alt="" /></p>

<h1 id="一简介">一、简介</h1>
<hr />

<p>CSP 的实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，等同于提供白名单。它的实现和执行全部由浏览器完成，开发者只需提供配置。</p>

<p>CSP 大大增强了网页的安全性。攻击者即使发现了漏洞，也没法注入脚本，除非还控制了一台列入了白名单的可信主机。</p>

<p>两种方法可以启用 CSP。一种是通过 HTTP 头信息的<code class="highlighter-rouge">Content-Security-Policy</code>的字段。</p>

<p><img src="http://i.imgur.com/YR8mHyA.jpg" alt="" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>Content-Security-Policy: script-src 'self'; object-src 'none';
style-src cdn.example.org third-party.org; child-src https:
</code></pre>
</div>

<p>另一种是通过网页的<code class="highlighter-rouge">&lt;meta&gt;</code>标签。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;meta http-equiv="Content-Security-Policy" content="script-src 'self'; object-src 'none'; style-src cdn.example.org third-party.org; child-src https:"&gt;
</code></pre>
</div>

<p>上面代码中，CSP 做了如下配置。</p>

<ol>
  <li>脚本：只信任当前域名</li>
  <li>
    <object>标签：不信任任何URL，即不加载任何资源
</object>
  </li>
  <li>样式表：只信任cdn.example.org和third-party.org</li>
  <li>框架（frame）：必须使用HTTPS协议加载</li>
  <li>其他资源：没有限制</li>
</ol>

<p>启用后，不符合 CSP 的外部资源就会被阻止加载。</p>

<p>Chrome 的报错信息。</p>

<p><img src="http://i.imgur.com/Rsmjnsz.png" alt="" /></p>

<p>Firefox 的报错信息。</p>

<p><img src="http://i.imgur.com/RHU6Lfo.png" alt="" /></p>
<h1 id="二限制选项">二、限制选项</h1>
<hr />

<p>CSP 提供了很多限制选项，涉及安全的各个方面。</p>

<h2 id="21-资源加载限制">2.1 资源加载限制</h2>

<p>以下选项限制各类资源的加载。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>script-src：外部脚本
style-src：样式表
img-src：图像
media-src：媒体文件（音频和视频）
font-src：字体文件
object-src：插件（比如 Flash）
child-src：框架
frame-ancestors：嵌入的外部资源（比如&lt;frame&gt;、&lt;iframe&gt;、&lt;embed&gt;和&lt;applet&gt;）
connect-src：HTTP 连接（通过 XHR、WebSockets、EventSource等）
worker-src：worker脚本
manifest-src：manifest 文件
</code></pre>
</div>

<h2 id="22-default-src">2.2 default-src</h2>

<p><code class="highlighter-rouge">default-src</code>用来设置上面各个选项的默认值。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Content-Security-Policy: default-src 'self'
</code></pre>
</div>

<p>上面代码限制所有的外部资源，都只能从当前域名加载。</p>

<p>如果同时设置某个单项限制（比如<code class="highlighter-rouge">font-src</code>）和<code class="highlighter-rouge">default-src</code>，前者会覆盖后者，即字体文件会采用<code class="highlighter-rouge">font-src</code>的值，其他资源依然采用<code class="highlighter-rouge">default-src</code>的值。</p>

<h2 id="23-url-限制">2.3 URL 限制</h2>

<p>有时，网页会跟其他 URL 发生联系，这时也可以加以限制。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>frame-ancestors：限制嵌入框架的网页
base-uri：限制&lt;base#href&gt;
form-action：限制&lt;form#action&gt;
</code></pre>
</div>

<h2 id="24-其他限制">2.4 其他限制</h2>

<p>其他一些安全相关的功能，也放在了 CSP 里面。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>block-all-mixed-content：HTTPS 网页不得加载 HTTP 资源（浏览器已经默认开启）
upgrade-insecure-requests：自动将网页上所有加载外部资源的 HTTP 链接换成 HTTPS 协议
plugin-types：限制可以使用的插件格式
sandbox：浏览器行为的限制，比如不能有弹出窗口等。
</code></pre>
</div>

<h2 id="25-report-uri">2.5 report-uri</h2>

<p>有时，我们不仅希望防止 XSS，还希望记录此类行为。report-uri就用来告诉浏览器，应该把注入行为报告给哪个网址。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Content-Security-Policy: default-src 'self'; ...; report-uri /my_amazing_csp_report_parser;
</code></pre>
</div>

<p>上面代码指定，将注入行为报告给/my_amazing_csp_report_parser这个 URL。</p>

<p>浏览器会使用POST方法，发送一个JSON对象，下面是一个例子。</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nt">"csp-report"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nt">"document-uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://example.org/page.html"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"referrer"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://evil.example.com/"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"blocked-uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://evil.example.com/evil.js"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"violated-directive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"script-src 'self' https://apis.google.com"</span><span class="p">,</span><span class="w">
    </span><span class="nt">"original-policy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"script-src 'self' https://apis.google.com; report-uri http://example.org/my_amazing_csp_report_parser"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<h1 id="三content-security-policy-report-only">三、Content-Security-Policy-Report-Only</h1>
<hr />

<p>除了Content-Security-Policy，还有一个Content-Security-Policy-Report-Only字段，表示不执行限制选项，只是记录违反限制的行为。</p>

<p>它必须与report-uri选项配合使用。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Content-Security-Policy-Report-Only: default-src 'self'; ...; report-uri /my_amazing_csp_report_parser;
</code></pre>
</div>

<h1 id="四选项值">四、选项值</h1>
<hr />

<p>每个限制选项可以设置以下几种值，这些值就构成了白名单。</p>

<ol>
  <li>主机名：example.org，https://example.com:443</li>
  <li>路径名：example.org/resources/js/</li>
  <li>通配符：<em>.example.org，</em>://<em>.example.com:</em>（表示任意协议、任意子域名、任意端口）</li>
  <li>协议名：https:、data:</li>
  <li>关键字’self’：当前域名，需要加引号</li>
  <li>关键字’none’：禁止加载任何外部资源，需要加引号</li>
</ol>

<p>多个值也可以并列，用空格分隔。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Content-Security-Policy: script-src 'self' https://apis.google.com
</code></pre>
</div>

<p>如果同一个限制选项使用多次，只有第一次会生效。</p>

<div class="highlighter-rouge"><pre class="highlight"><code># 错误的写法
script-src https://host1.com; script-src https://host2.com

# 正确的写法
script-src https://host1.com https://host2.com
</code></pre>
</div>

<p>如果不设置某个限制选项，就是默认允许任何值。</p>

<h1 id="五script-src-的特殊值">五、script-src 的特殊值</h1>
<hr />

<p>除了常规值，script-src还可以设置一些特殊值。注意，下面这些值都必须放在单引号里面。</p>

<ul>
  <li>‘unsafe-inline’：允许执行页面内嵌的&lt;script&gt;标签和事件监听函数</li>
  <li>unsafe-eval：允许将字符串当作代码执行，比如使用eval、setTimeout、setInterval和Function等函数。</li>
  <li>nonce值：每次HTTP回应给出一个授权token，页面内嵌脚本必须有这个token，才会执行</li>
  <li>hash值：列出允许执行的脚本代码的Hash值，页面内嵌脚本的哈希值只有吻合的情况下，才能执行。</li>
</ul>

<p>nonce值的例子如下，服务器发送网页的时候，告诉浏览器一个随机生成的token。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Content-Security-Policy: script-src 'nonce-EDNnf03nceIOfn39fn3e9h3sdfa'
</code></pre>
</div>

<p>页面内嵌脚本，必须有这个token才能执行。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;script nonce=EDNnf03nceIOfn39fn3e9h3sdfa&gt;
  // some code
&lt;/script&gt;
</code></pre>
</div>

<p>hash值的例子如下，服务器给出一个允许执行的代码的hash值。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>Content-Security-Policy: script-src 'sha256-qznLcsROx4GACP2dm0UCKCzCG-HiZ1guq6ZZDob_Tng='
</code></pre>
</div>

<p>下面的代码就会允许执行，因为hash值相符。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;script&gt;alert('Hello, world.');&lt;/script&gt;
</code></pre>
</div>

<p>注意，计算hash值的时候，<code class="highlighter-rouge">&lt;script&gt;</code>标签不算在内。</p>

<p>除了<code class="highlighter-rouge">script-src</code>选项，nonce值和hash值还可以用在<code class="highlighter-rouge">style-src</code>选项，控制页面内嵌的样式表。</p>

<h1 id="六注意点">六、注意点</h1>
<hr />

<p>（1）<code class="highlighter-rouge">script-src</code>和<code class="highlighter-rouge">object-src</code>是必设的，除非设置了<code class="highlighter-rouge">default-src</code>。</p>

<p>因为攻击者只要能注入脚本，其他限制都可以规避。而object-src必设是因为 Flash 里面可以执行外部脚本。</p>

<p>（2）<code class="highlighter-rouge">script-src</code>不能使用unsafe-inline关键字（除非伴随一个nonce值），也不能允许设置data:URL。</p>

<p>下面是两个恶意攻击的例子。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;img src="x" onerror="evil()"&gt;
&lt;script src="data:text/javascript,evil()"&gt;&lt;/script&gt;
</code></pre>
</div>

<p>（3）必须特别注意 JSONP 的回调函数。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>&lt;script
	src="/path/jsonp?callback=alert(document.domain)//"&gt;
&lt;/script&gt;
</code></pre>
</div>

<p>上面的代码中，虽然加载的脚本来自当前域名，但是通过改写回调函数，攻击者依然可以执行恶意代码。</p>

<hr />

<h1 id="声明本文转载至阮大神的博客">声明：本文转载至阮大神的博客</h1>
<p>《<a href="http://www.ruanyifeng.com/blog/2016/09/csp.html?hmsr=toutiao.io&amp;utm_medium=toutiao.io&amp;utm_source=toutiao.io">Content Security Policy 入门教程</a>》</p>


	
</article>


	<footer>
		<p>&copy; Since 2016 <a href="http://wilsonis.github.io/myblog/">wilsonisonly.com</a></p>
	</footer>
</div>

<nav class="block">
	<ul>
		<li class="thinking"><a href="/blog/category/thinking/">Why...</a></li>
		<li class="experience"><a href="/blog/category/experience/">How To Do</a></li>
		<li class="discovery"><a href="/blog/category/discovery/">What's New</a></li>
		<li class="criticism"><a href="/blog/category/criticism/">What's Wrong</a></li>
		<li class="communication"><a href="/blog/category/communication/">Sharing</a></li>
		
	</ul>
</nav>
<aside id="page">
	<h2><a href="/"><i class="fa fa-home"></i></a> / <a href="/blog/">追梦者</a><a href="/blog/feed.xml" class="feed-link" title="Subscribe"><i class="fa fa-rss-square"></i></a></h2>

	<div class="block block-about">
		<h3>关于</h3>
		<figure>
			<img src="../potrait.png" width="80" height="80" />
			<figcaption><strong>wilsonIsOnly</strong></figcaption>
		</figure>
	</div>

	<div class="block block-license">
		<h3>版权申明</h3>
		<p><a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/2.5/cn/" target="_blank" class="hide-target-icon" title="本站(博客)作品全部采用知识共享署名-非商业性使用-禁止演绎 2.5 中国大陆许可协议进行许可。转载请通知作者并注明出处。"><img alt="知识共享许可协议" src="http://i.creativecommons.org/l/by-nc-nd/2.5/cn/88x31.png" /></a></p>
	</div>

	<div class="block block-thank">
		<h3>Powered by</h3>
		<p>
			<a href="http://elfjs.com/" target="_blank">elf+js</a>,
			<a href="https://github.com/" target="_blank">GitHub</a>,
			<a href="http://softwaremaniacs.org/soft/highlight/en/">HighlightJS</a>,
			<a href="https://github.com/mojombo/jekyll" target="_blank">jekyll</a>,
		</p>
	</div>

	<!--  最近访客 -->
	<div id="visitors" class="block">
		<p>最近访客</p>
		<ul class="ds-recent-visitors" data-num-items="10"></ul>
		<p>你是第
			<img border="0" src="http://cc.amazingcounters.com/counter.php?i=3212244&c=9637045" alt="AmazingCounters.com">
			位访客
		</p>
	</div>
</aside>

<script src="../lib/particles/particles.js"></script>
<script src="../lib/particles/app.js"></script>
<script type="text/javascript" src="/lib/elf/elf-0.5.0.min.js"></script>
<script src="/lib/highlight/highlight.min.js"></script>
<script src="/assets/js/site.js"></script>

<script>
site.URL_GOOGLE_API = '';

site.VAR_SITE_NAME = '追梦者';
site.VAR_AUTO_LOAD_ON_SCROLL = 0;
</script>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?2dd5c7dc6775d11bc19cce5ce2f9bc70";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script src="https://www.sobot.com/chat/frame/js/entrance.js?sysNum=849a418af6db4f148b63884b350e60b5" class="zhiCustomBtn" id="zhichiScript" data-args="属性名1=属性值1&属性名2=属性值2"></script>
</body>
</html>
